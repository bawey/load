module fedIdConsistency;

// question: is it OKAY and is it needed at all?
@Description('detect any pair of frlcontrollerLink events with the same FEDSourceId and differing (link, slot, context) triplet')
@Verbose(label='error', extraNfo='Duplicate FEDSourceId!')
select * from frlcontrollerLink match_recognize(
	partition by FEDSourceId
	measures A.linkNumber as prevLink, A.slotNumber as prevSlot, A.context as prevContext, B.slotNumber as newSlot, B.linkNumber as newLink, B.context as newContext, B.FEDSourceId as srcFedId
	pattern (A B)
	define
		B as B.FEDSourceId!=0 and (B.linkNumber!=A.linkNumber or B.context != A.context or B.slotNumber != A.slotNumber)
);


@Description('make sure that given triplet resolves to the same FEDSrcId')
create window ConfirmedFeds.std:unique(fedId) as select FEDSourceId as fedId from frlcontrollerLink;
create window DeniedFeds.std:unique(fedId) as select * from ConfirmedFeds;
on frlcontrollerLink as a insert into ConfirmedFeds select a.FEDSourceId as fedId 
	where a.FEDSourceId not in (select fedId from ConfirmedFeds) and a.FEDSourceId = HwInfo.getInstance().getFedId(a.context, a.slotNumber, a.linkNumber, CmsHw.FRL);
@Watched(label='Verified FED IDs')
select count(*) from ConfirmedFeds;

